stages:
  - test
  - build

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  ASPNETCORE_ENVIRONMENT: "Development"
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - dotnet tool install --tool-path .dotnet/tools dotnet-reportgenerator-globaltool
    - export PATH="$PATH:$CI_PROJECT_DIR/.dotnet/tools"

    - dotnet test --logger "console;verbosity=detailed" --collect:"XPlat Code Coverage"

    - |
      if ls TestResults/**/coverage.cobertura.xml >/dev/null 2>&1; then
        reportgenerator -reports:"TestResults/**/coverage.cobertura.xml" -targetdir:coveragereport -reporttypes:TextSummary
        cat coveragereport/Summary.txt || true
      else
        echo "No coverage files found, skipping report generation"
      fi
  artifacts:
    paths:
      - coveragereport/
      - TestResults/
    expire_in: 1 week
  cache:
    key: nuget
    paths:
      - ~/.nuget/packages

build:
  stage: build
  needs: [test]
  image: docker:latest
  services:
    - docker:dind
  tags:
    - smartech-dind-runner
  script:
    - |
      export IMAGE_TAG=$(date +%Y%m%d)-${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}
      echo "Building image with tag: $IMAGE_TAG"
      docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
      docker build --pull -t "$CI_REGISTRY_IMAGE:$IMAGE_TAG" -t "$CI_REGISTRY_IMAGE:latest" .
      docker push "$CI_REGISTRY_IMAGE:$IMAGE_TAG"
      docker push "$CI_REGISTRY_IMAGE:latest"
